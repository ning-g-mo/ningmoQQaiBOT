# 图片处理功能说明

## 概述

柠枺AI机器人现在支持处理用户发送的图片，可以将图片内容传递给AI模型进行分析和回复。当用户发送包含图片的消息时，机器人会自动下载图片、转换为base64格式，并发送给AI模型进行处理。

## 功能特性

### 支持的图片格式
- JPEG (.jpg, .jpeg)
- PNG (.png)
- GIF (.gif)
- WebP (.webp)

### 支持的AI模型
- **OpenAI模型** (GPT-4 Vision, GPT-3.5 Turbo等)
- **Anthropic Claude模型** (Claude-3系列)
- **DeepSeek模型** (支持视觉的版本)
- **本地LLM模型** (支持OpenAI兼容API的本地模型)
- **通用API模型** (支持图片的自定义API)

### 安全限制
- 最大图片大小：10MB (可配置)
- 下载超时：30秒 (可配置)
- 自动格式检查
- 内容类型验证

## 配置说明

### 图片处理配置

在 `config.yml` 文件中，可以配置图片处理相关参数：

```yaml
ai:
  # 图片处理配置
  image:
    enabled: true               # 是否启用图片处理功能
    max_size_mb: 10             # 最大图片大小（MB）
    timeout_seconds: 30         # 图片下载超时时间（秒）
    supported_formats:          # 支持的图片格式
      - "image/jpeg"
      - "image/png"
      - "image/gif"
      - "image/webp"
```

### 模型配置

确保使用的AI模型支持图片处理。以下是一些推荐的模型配置：

#### OpenAI GPT-4 Vision
```yaml
ai:
  models:
    gpt-4-vision:
      type: "openai"
      description: "OpenAI GPT-4 Vision模型（支持图片识别）"
      model_name: "gpt-4-vision-preview"
      api_base_url: "https://api.openai.com"
      max_tokens: 4000
```

#### Claude-3 系列
```yaml
ai:
  models:
    claude-3-opus:
      type: "anthropic"
      description: "Claude 3 Opus - 支持图片分析"
      model_name: "claude-3-opus-20240229"
```

## 使用方法

### 群聊中使用

1. 在群聊中发送包含图片的消息
2. 可以同时发送文字和图片
3. 机器人会自动识别图片并进行分析
4. AI会根据图片内容和文字内容进行回复

示例：
```
用户：[发送一张猫的图片] 这是什么品种的猫？
机器人：根据图片分析，这是一只橘猫，具体品种可能是...
```

### 私聊中使用

1. 在私聊中发送包含图片的消息
2. 机器人会同样处理图片并回复

### 多图片支持

机器人支持同时处理多张图片：
```
用户：[发送多张图片] 这些图片有什么共同点？
机器人：分析这些图片后，我发现它们的共同点是...
```

## 技术实现

### 图片处理流程

1. **CQ码解析**：从QQ消息中提取图片CQ码
2. **URL提取**：从CQ码中获取图片URL
3. **图片下载**：下载图片到本地内存
4. **格式验证**：检查图片格式和大小
5. **Base64编码**：将图片转换为base64格式
6. **发送给AI**：将图片数据发送给AI模型
7. **生成回复**：AI分析图片并生成回复

### 错误处理

- 图片下载失败：记录错误日志，继续使用纯文本模式
- 图片格式不支持：跳过该图片，处理其他图片
- 图片过大：跳过该图片，记录警告日志
- 网络超时：设置合理的超时时间，避免长时间等待

## 注意事项

### 性能考虑
- 图片处理会增加响应时间
- 大图片会消耗更多内存和带宽
- 建议合理设置图片大小限制

### 隐私安全
- 图片会被发送到AI服务提供商
- 请确保遵守相关隐私政策
- 建议不要发送敏感或私密图片

### 网络要求
- 需要稳定的网络连接
- 图片下载可能受到网络环境影响
- 建议配置合适的超时时间

## 故障排除

### 常见问题

1. **图片无法处理**
   - 检查图片格式是否支持
   - 确认图片大小是否超限
   - 查看日志中的错误信息

2. **AI回复不包含图片分析**
   - 确认使用的模型支持图片处理
   - 检查模型配置是否正确
   - 查看图片是否成功下载

3. **响应时间过长**
   - 检查网络连接
   - 考虑减小图片大小
   - 调整超时配置

### 日志查看

查看日志文件 `logs/bot.log` 中的相关信息：
- 图片下载状态
- 处理错误信息
- 性能统计信息

## 更新日志

### v1.0.0
- 初始图片处理功能
- 支持多种图片格式
- 集成到所有主要AI模型
- 添加安全限制和错误处理

---

如有问题或建议，请联系开发者或提交Issue。
