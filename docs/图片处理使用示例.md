# 图片处理功能使用示例

## 基本使用

### 1. 群聊图片处理

当用户在群聊中发送包含图片的消息时，机器人会自动处理：

```java
// 用户发送的消息示例
String userMessage = "这是一张猫的图片[CQ:image,file=cat.jpg,url=http://example.com/cat.jpg] 这是什么品种？";

// 机器人会自动：
// 1. 检测到图片CQ码
// 2. 提取图片URL
// 3. 下载并编码图片
// 4. 发送给AI模型分析
// 5. 返回分析结果
```

### 2. 私聊图片处理

私聊中的图片处理与群聊相同：

```java
// 私聊消息示例
String privateMessage = "[CQ:image,file=document.png,url=http://example.com/document.png] 帮我分析这个文档";

// 机器人会同样处理图片并回复
```

## 代码示例

### 手动处理图片

如果需要手动处理图片，可以使用 `ImageProcessor` 类：

```java
import cn.ningmo.utils.ImageProcessor;
import cn.ningmo.config.ConfigLoader;

// 初始化
ConfigLoader configLoader = new ConfigLoader();
configLoader.loadConfig();
ImageProcessor imageProcessor = new ImageProcessor(configLoader);

// 处理消息中的图片
String message = "这是图片[CQ:image,file=test.jpg,url=http://example.com/test.jpg]";
ImageProcessor.ImageProcessResult result = imageProcessor.processImages(message);

if (result.hasImages()) {
    List<String> imageBase64List = result.getImageBase64List();
    System.out.println("成功处理 " + result.getSuccessCount() + " 张图片");
    
    // 将图片发送给AI模型
    String aiReply = aiService.chat(userId, message, imageBase64List);
} else if (result.hasError()) {
    System.out.println("图片处理错误: " + result.getErrorMessage());
}
```

### 使用CommonUtils工具类

```java
import cn.ningmo.utils.CommonUtils;

// 检查消息是否包含图片
String message = "包含图片的消息[CQ:image,file=test.jpg]";
if (CommonUtils.containsImage(message)) {
    // 提取图片CQ码
    List<String> imageCQCodes = CommonUtils.extractImageCQCodes(message);
    
    for (String cqCode : imageCQCodes) {
        // 提取图片URL
        String imageUrl = CommonUtils.extractImageUrlFromCQCode(cqCode);
        if (imageUrl != null) {
            // 下载并编码图片
            String imageBase64 = CommonUtils.downloadImageAsBase64(imageUrl);
            if (imageBase64 != null) {
                // 使用图片数据
                System.out.println("图片编码成功，大小: " + imageBase64.length() + " 字符");
            }
        }
    }
}
```

## 配置示例

### 启用图片处理

在 `config.yml` 中配置：

```yaml
ai:
  image:
    enabled: true               # 启用图片处理
    max_size_mb: 10             # 最大10MB
    timeout_seconds: 30         # 30秒超时
    supported_formats:          # 支持的格式
      - "image/jpeg"
      - "image/png"
      - "image/gif"
      - "image/webp"
```

### 配置支持图片的AI模型

```yaml
ai:
  models:
    gpt-4-vision:
      type: "openai"
      description: "GPT-4 Vision - 支持图片分析"
      model_name: "gpt-4-vision-preview"
      api_key: "your-api-key"
      max_tokens: 4000
    
    claude-3-opus:
      type: "anthropic"
      description: "Claude 3 Opus - 支持图片分析"
      model_name: "claude-3-opus-20240229"
      api_key: "your-api-key"
      max_tokens: 4000
```

## 错误处理示例

```java
// 处理图片时可能出现的错误
ImageProcessor.ImageProcessResult result = imageProcessor.processImages(message);

if (result.hasError()) {
    switch (result.getErrorMessage()) {
        case "图片处理功能已禁用":
            // 图片处理功能被禁用
            break;
        case "无法提取图片CQ码":
            // CQ码格式错误
            break;
        case "所有图片处理失败":
            // 所有图片都下载失败
            break;
        default:
            // 其他错误
            break;
    }
}

// 即使图片处理失败，也可以继续使用纯文本模式
String aiReply = aiService.chat(userId, message, result.getImageBase64List());
```

## 性能优化建议

### 1. 合理设置图片大小限制

```yaml
ai:
  image:
    max_size_mb: 5  # 根据网络情况调整
```

### 2. 设置合适的超时时间

```yaml
ai:
  image:
    timeout_seconds: 15  # 根据网络速度调整
```

### 3. 限制支持的格式

```yaml
ai:
  image:
    supported_formats:
      - "image/jpeg"  # 只支持JPEG，减少处理时间
```

## 日志监控

查看日志文件 `logs/bot.log` 中的图片处理信息：

```
INFO  - 图片处理器初始化完成: enabled=true, maxSize=10MB, timeout=30s
INFO  - 开始处理消息中的图片...
INFO  - 提取到 1 个图片CQ码
DEBUG - 开始下载图片: http://example.com/test.jpg
INFO  - 成功处理图片: http://example.com/test.jpg (大小: 12345 bytes)
INFO  - 图片处理完成: 成功 1/1, 准备发送给AI模型
```

## 常见问题解决

### 1. 图片下载失败

检查网络连接和图片URL是否有效：

```java
// 手动测试图片下载
String imageUrl = "http://example.com/test.jpg";
String imageBase64 = CommonUtils.downloadImageAsBase64(imageUrl);
if (imageBase64 == null) {
    System.out.println("图片下载失败，请检查URL和网络连接");
}
```

### 2. 图片格式不支持

检查配置中的支持格式：

```yaml
ai:
  image:
    supported_formats:
      - "image/jpeg"
      - "image/png"
      # 添加需要的格式
```

### 3. 图片过大

调整大小限制或压缩图片：

```yaml
ai:
  image:
    max_size_mb: 20  # 增加大小限制
```

---

这些示例展示了如何在柠枺AI机器人中使用图片处理功能。根据实际需求，可以调整配置和代码实现。
